# Hooks

Hooks allow you to interact with a pre-defined task and alter its behaviors.

The main configuration object generated by `@wok-cli/core` exposes a global hook object called `globalHooks` that you can leverage inside your tasks to interact with them at runtime:

<!-- TOC -->

- [Working with Global Hooks](#working-with-global-hooks)
- [Hook function signature](#hook-function-signature)
- [Working with Task Hooks](#working-with-task-hooks)
  - [Inside a task function](#inside-a-task-function)
  - [Enqueuing hook functions](#enqueuing-hook-functions)
- [Custom Accumulators](#custom-accumulators)
- [Interact with hooks](#interact-with-hooks)
- [Known Issues](#known-issues)
  - [Non Completing Tasks](#non-completing-tasks)

<!-- /TOC -->

## Working with Global Hooks

Let's say we have a `scripts` task that just copies files from one folder to another:

```js
// tasks/scripts.js

module.exports = function scriptsTask(gulp, params, env, api) {
  return function scripts() {
    return gulp.src(params.src).pipe(gulp.dest(params.dest));
  };
};
```

And we use it like this:

```js
// gulpfile.js
const $ = require('@wok-cli/core');
const scriptsTask = require('./tasks/scripts.js');

const scripts = $.task(scriptsTask, {
  src: 'src/**',
  dest: 'public',
});

exports.scripts = scripts;
```

To be able to leverage hooks we must define where to call them inside the task:

```diff
// tasks/scripts.js

module.exports = function scriptsTask(gulp, params, env, api) {
  return function scripts() {
    return gulp
      .src(params.src)
+     .pipe(api.globalHooks.call('scripts'))
      .pipe(gulp.dest(params.dest));
  };
};
```

We can then enqueue a hook transformation in `gulpfile.js` using the `.tap()` method. For example let's run the code through a minifier plugin like [gulp-terser](https://www.npmjs.com/package/gulp-terser):

```diff
// gulpfile.js
const $ = require('@wok-cli/core');
const scriptsTask = require('./tasks/scripts.js');

const scripts = $.task(scriptsTask, {
  src: 'src/**',
  dest: 'public',
});

+ $.api.globalHooks.tap('scripts', 'minify', (lazypipe) => lazypipe.pipe(require('gulp-terser')));

exports.scripts = scripts;
```

## Hook function signature

The `.tap()` third argument is called **hook function**. It receives the following arguments:

- an accumulator object (defaults to a [lazypipe](https://github.com/OverZealous/lazypipe) stream)
- the value of `$.env`
- the value of `$.api`
- any other argument passed to `.call()` after the hook name.

This let's you, for example, programmatically add or remove a gulp plugin based on the current environment:

```js
// minify the source just on production
function minify(lazypipe, env) {
  if (env.production !== true) {
    return lazypipe;
  }
  return lazypipe.pipe(require('gulp-terser'));
}

$.api.globalHooks.tap('scripts', 'minify', minify);
```

!> **Important**: Consecutive hook functions will receive the accumulator object returned from the previous one. Always remember to return the accumulator inside a hook function!

## Working with Task Hooks

While global hooks might be useful to share common behaviors, each task created by the `$.task` function exposes a hooks API that is local to the task itself.

### Inside a task function

Inside the task function call `this.getHooks()` to retrieve the local hooks object:

```diff
// tasks/scripts.js

module.exports = function scriptsTask(gulp, params, env, api) {

+ const $hooks = this.getHooks();

  return function scripts() {
    return gulp
      .src(params.src)
-     .pipe(api.globalHooks.call('scripts'))
+     .pipe($hooks.call('default'))
      .pipe(gulp.dest(params.dest));
  };
};
```

!> **Note**: since arrow functions [don't have their own `this`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions#No_separate_this), you need to stick to the `function` statement to retrieve the local hooks API with `this.getHooks()`.

### Enqueuing hook functions

To enqueue an hook function to Wok task call its `.tap()` method:

```diff
// gulpfile.js
// ...

const scripts = $.task(scriptsTask, {
  src: 'src/**',
  dest: 'public',
});

- $.api.globalHooks.tap('scripts', 'minify', (lazypipe) => lazypipe.pipe(require('gulp-terser')));
+ scripts.tap('default', 'minify', (lazypipe) => lazypipe.pipe(require('gulp-terser')));

exports.scripts = scripts;
```

?> **Tip** You can access the complete hooks api of the task from `scripts.$hooks`.

## Custom Accumulators

By default hooks accumulators are [lazypipe](https://github.com/OverZealous/lazypipe) streams. Anyway you can define your own accumulator by calling `.callWith()` instead of `.call()` and passing your custom value as second argument:

```js
const { globalHooks } = $.api;

globalHooks.tap('value', 'multiply', (num) => num * 2);

const number = globalHooks.callWith('value', 10);

// number === 10
```

## Interact with hooks

Each hooks object lets you finely interact with registered hook functions. You can, for example, remove any previously enqueued function with the `delete()` method:

```js
// remove the minify hook function
$.api.globalHooks.delete('scripts', 'minify');

// remove any function registered for the scripts hook
$.api.globalHooks.delete('scripts');
```

Refer to the [`Hook` class API](packages/core/api/lib/hooks) for further details.

## Known Issues

### Non Completing Tasks

If you call a hook as the last step of a task's stream that task [might not complete correctly](https://stackoverflow.com/questions/40098156/what-about-this-combination-of-gulp-concat-and-lazypipe-is-causing-an-error-usin/40101404#40101404).

For example take this copy task:

```js
function copyTask(gulp) {
  const $hooks = this.getHooks();

  return function copy() {
    gulp
      .src('src/**')
      .pipe(gulp.dest('public'))
      .pipe($hooks.call('complete'));
    // ^-- this will not complete
  };
}
```

In order to make it work you need to add an empty stream after the hook. You can use the `noopStream` utility function provided by `@wok-cli/core`:

```diff
+ const { noopStream } = require('@wok-cli/core');

function copyTask(gulp) {
  const $hooks = this.getHooks();

  return function copy() {
    gulp
      .src('src/**')
      .pipe(gulp.dest('public'))
      .pipe($hooks.call('complete'))
+     .pipe(noopStream());
  };
}
```
